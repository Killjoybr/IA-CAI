import sys
from typing import List, Dict
from tqdm import tqdm

from scanner_core import SimpleWebScanner
from ml_model import SeverityModel


def print_intro(target: str):
    print("=" * 60)
    print(" AGENTE DE PENTEST WEB")
    print("=" * 60)
    print(f"Alvo: {target}")
    print("=" * 60)
    print()


def pretty_print_finding(f: Dict, severity_label: str, severity_score: float):
    print("-" * 40)
    print(f"Tipo:           {f.get('type')}")
    if f.get("url"):
        print(f"URL:            {f.get('url')}")
    if f.get("param"):
        print(f"Parâmetro:      {f.get('param')}")
    if f.get("header"):
        print(f"Header:         {f.get('header')}")
    print(f"Descrição:      {f.get('detail')}")
    if f.get("payload"):
        print(f"Payload usado:  {f.get('payload')}")
    print(f"Severidade IA:  {severity_label}  (confiança: {severity_score:.2f})")


def main():
    if len(sys.argv) != 2:
        print(f"Uso: python {sys.argv[0]} <URL-alvo>")
        sys.exit(1)

    target = sys.argv[1]
    print_intro(target)

    scanner = SimpleWebScanner(target, max_pages=15)
    model = SeverityModel()

    print("[1] Descobrindo páginas (crawl leve)...")
    urls = scanner.crawl()
    print(f"URLs descobertas ({len(urls)}):")
    for u in urls:
        print("  -", u)
    print()

    print("[2] Executando testes de vulnerabilidade em cada URL...")
    all_findings: List[Dict] = []
    for url in tqdm(urls):
        # headers
        all_findings.extend(scanner.check_security_headers(url))
        # só testa XSS/SQLi se tiver parâmetros
        if scanner.extract_params(url):
            all_findings.extend(scanner.test_reflected_xss(url))
            all_findings.extend(scanner.test_basic_sqli(url))

    if not all_findings:
        print("\nNenhuma potencial vulnerabilidade encontrada pelo protótipo.")
        sys.exit(0)

    print(f"\n[3] Classificando severidade com modelo de IA...")
    enriched = []
    for f in all_findings:
        sev_cls, sev_conf = model.predict_severity(f)
        sev_label = model.label_from_class(sev_cls)
        f["severity_class"] = sev_cls
        f["severity_label"] = sev_label
        f["severity_confidence"] = sev_conf
        enriched.append(f)

    # ordena por severidade (alto -> baixo), depois confiança
    enriched.sort(key=lambda x: (-x["severity_class"], -x["severity_confidence"]))

    print("\n=== RELATÓRIO DO AGENTE ===\n")
    for f in enriched:
        pretty_print_finding(f, f["severity_label"], f["severity_confidence"])
    print("-" * 40)
    print(f"Total de achados: {len(enriched)}")
    print("Legenda severidade: baixo(0), médio(1), alto(2)")


if __name__ == "__main__":
    main()